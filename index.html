<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Viewer - AR360.io</title>
    <style>
        html:not(.ready) [type=reset],html:not(.ready) [type=submit] {
            pointer-events: none
        }

        html:not(.ready) * {
            transition: none!important
        }

        html, body {
            margin: 0;
            padding: 0;
            width:100%;
            height:100%;
            font-family: Open Sans,sans-serif;
        }

        /* Stil für das Logo */
        .logo-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .logo-container img {
            width: 200px; /* Ändere die Größe nach Bedarf */
            height: auto;
        }
    </style>
    <link rel="stylesheet" href="https://ar360.io/css/ar360.css"/>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

    <!-- Logo-Container -->
    <div class="logo-container">
        <img src="logo.png" alt="Mein Logo">
    </div>

    <model-viewer
        class="viewer"
        style="width:100%;height:100%"
        src="https://jasminnicola1.github.io/3D-Model/3D_Becher.glb"
        enable-pan
        min-field-of-view="1deg"
        max-field-of-view="150deg"
        interaction-prompt="none"
        camera-controls
        oncontextmenu="return false;"
        alt="A 3D model">
        <div class="loading-container">
            <div class="main-progress ">
                <img alt="Loading 3D Model" src="https://ar360.io/models/e1c7a8c8d9794f31842b7eeba5b6ec9e/thumbnail-mini.png" class="loading-thumbnail">
                <div class="main-progress-wrapper">
                    <div class="main-progress-percentage loading-percentage">0%</div>
                    <p>Loading 3D model</p>
                    <div class="main-progress-display">
                        <div class="main-progress-display__progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </model-viewer>

    <script>
        const modelViewer = document.querySelector("model-viewer");
        const progressBar = document.querySelector('.main-progress-display__progress');
        const animationPlay = document.querySelector(".animation-play");
        const animationRewind = document.querySelector(".animation-rewind");

        let selectedHotspot;
        const tapDistance = 2;
        let panning = false;
        let panX, panY;
        let startX, startY;
        let lastX, lastY;
        let metersPerPixel;
        let arButtonClicked = false;

        let loading = true;

        const onProgress = (event) => {
            if(loading) {
                progressBar.style.width = `${event.detail.totalProgress * 100}%`;
                if (event.detail.totalProgress === 1) {
                    loading = false;
                    modelViewer.classList.add('model-loaded');
                    document.documentElement.classList.add('ready');
                }
            }
        };

        modelViewer.addEventListener('progress', onProgress);

        const startPan = () => {
            const orbit = modelViewer.getCameraOrbit();
            const {theta, phi, radius} = orbit;
            const psi = theta - modelViewer.turntableRotation;
            metersPerPixel = 0.75 * radius / modelViewer.getBoundingClientRect().height;
            panX = [-Math.cos(psi), 0, Math.sin(psi)];
            panY = [
                -Math.cos(phi) * Math.sin(psi),
                Math.sin(phi),
                -Math.cos(phi) * Math.cos(psi)
            ];
            modelViewer.interactionPrompt = 'none';
        };

        const movePan = (thisX, thisY) => {
            const dx = (thisX - lastX) * metersPerPixel;
            const dy = (thisY - lastY) * metersPerPixel;
            lastX = thisX;
            lastY = thisY;

            const target = modelViewer.getCameraTarget();
            target.x += dx * panX[0] + dy * panY[0];
            target.y += dx * panX[1] + dy * panY[1];
            target.z += dx * panX[2] + dy * panY[2];
            modelViewer.cameraTarget = `${target.x}m ${target.y}m ${target.z}m`;

            modelViewer.dispatchEvent(new CustomEvent('camera-change', {detail: {source: 'user-interaction'}}));
        };

        const recenter = (pointer) => {
            panning = false;
            if (Math.abs(pointer.clientX - startX) > tapDistance ||
                Math.abs(pointer.clientY - startY) > tapDistance)
                return;
            const hit = modelViewer.positionAndNormalFromPoint(pointer.clientX, pointer.clientY);
            modelViewer.cameraTarget =
                hit == null ? 'auto auto auto' : hit.position.toString();
        };

        modelViewer.addEventListener('mousedown', (event) => {
            let offsetTop = modelViewer.offsetTop;
            let offsetLeft = modelViewer.offsetLeft;
            let offsetHeight = modelViewer.offsetHeight;
            let offsetWidth = modelViewer.offsetWidth;
            let pageX = event.pageX;
            let pageY = event.pageY;
            let offsetY = offsetHeight - pageY + offsetTop;
            let offsetX = offsetWidth - pageX + offsetLeft;
            if(offsetY < 60 && offsetX < 60) {
                arButtonClicked = true;
                return;
            }
            arButtonClicked = false;

            startX = event.clientX;
            startY = event.clientY;
            panning = event.button === 2 || event.ctrlKey || event.metaKey || event.shiftKey;
            if (!panning) return;

            lastX = startX;
            lastY = startY;
            startPan();
            event.stopPropagation();
        }, true);

        self.addEventListener('mousemove', (event) => {
            if (!panning) return;

            movePan(event.clientX, event.clientY);
            event.stopPropagation();
        }, true);

        self.addEventListener('mouseup', (event) => {
            if(arButtonClicked) return;
            recenter(event);
        }, true);

        modelViewer.addEventListener('load', function(evt) {
            for (let i = 0; i < modelViewer.children.length; i++) {
                modelViewer.children[i].style.display = 'block';
                modelViewer.children[i].addEventListener('click', (event) => {
                    event.stopPropagation();
                    select(modelViewer.children[i]);
                });
            }
        });

        function select(hotspot) {
            hideSelectedHotspot();
            hotspot.classList.add('selected');
            selectedHotspot = hotspot;
        }

        document.addEventListener('click', function () {
            hideSelectedHotspot();
        });

        function hideSelectedHotspot() {
            if(selectedHotspot){
                selectedHotspot.classList.remove('selected');
                selectedHotspot = null;
            }
        }

        if(animationPlay){
            animationPlay.addEventListener('click', function(){
                if (modelViewer.paused){
                    modelViewer.play();
                    console.log('play')
                } else {
                    modelViewer.pause();
                    console.log('pause')
                }
            });
        }

        if(animationRewind){
            animationRewind.addEventListener('click', function(){
                let time = modelViewer.currentTime;
                console.log(time);
                if (time<5){
                    time = 0
                } else {
                    time = time - 5;
                }

                modelViewer.currentTime = time
                console.log('rewind 5')
            });
        }
    </script>
</body>
</html>
